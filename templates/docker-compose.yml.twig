version: '3'

services:
  mariadb:
    image: 'wodby/mariadb:$MARIADB_TAG'
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: drupal
      MYSQL_USER: drupal
      MYSQL_PASSWORD: drupal
    volumes:
      - ./db:/docker-entrypoint-initdb.d

  php:
    image: 'wodby/drupal-php:$PHP_TAG'
    environment:
      PHP_SENDMAIL_PATH: /usr/sbin/sendmail -t -i -S mailhog:1025
      DB_HOST: mariadb
      DB_USER: drupal
      DB_PASSWORD: drupal
      DB_NAME: drupal
      DB_DRIVER: mysql
{% if php.xdebug %}
      PHP_XDEBUG: 1
      PHP_XDEBUG_DEFAULT_ENABLE: 1
      PHP_XDEBUG_REMOTE_AUTOSTART: 1
      PHP_XDEBUG_REMOTE_HOST: {{ docker0.ip }}
      PHP_IDE_CONFIG: serverName=Docker
      PHP_XDEBUG_REMOTE_CONNECT_BACK: 1
{% if webgrind.enable %}
      PHP_XDEBUG_PROFILER_ENABLE: 1
      PHP_XDEBUG_PROFILER_ENABLE_TRIGGER: 1
      PHP_XDEBUG_PROFILER_ENABLE_TRIGGER_VALUE: 1
      PHP_XDEBUG_PROFILER_OUTPUT_DIR: /mnt/files/xdebug/profiler
      PHP_XDEBUG_TRACE_OUTPUT_DIR: /mnt/files/xdebug/traces
{% endif %}
{% endif %}
{% if blackfire.enable %}
      PHP_BLACKFIRE: 1
{% endif %}
    volumes:
      - ./:/var/www/html
      - ./drush:/etc/drush
{% if php.ssh %}
      - {{ php.ssh_auth_sock }}:/ssh-agent
{% endif %}
{% if webgrind.enable %}
      - files:/mnt/files
{% endif %}

  {{ webserver.type }}:
{% if webserver.type == 'nginx' %}
    image: 'wodby/drupal-nginx:$NGINX_TAG'
{% elseif webserver.type == 'apache' %}
    image: 'wodby/php-apache:$APACHE_TAG'
{% endif %}
    depends_on:
      - php
    environment:
{% if webserver.type == 'nginx' %}
{% if live is defined and live.uri is defined %}
      NGINX_DRUPAL_FILE_PROXY_URL: '{{ live.uri }}'
{% endif %}
      NGINX_STATIC_CONTENT_OPEN_FILE_CACHE: 'off'
      NGINX_ERROR_LOG_LEVEL: debug
{% elseif webserver.type == 'apache' %}
      APACHE_LOG_LEVEL: debug
{% endif %}
      {{ webserver.type|upper }}_BACKEND_HOST: php
      {{ webserver.type|upper }}_SERVER_ROOT: /var/www/html/{{ webRoot }}
    volumes:
      - ./:/var/www/html
    labels:
      traefik.backend: '{{ project_name }}_{{ webserver.type }}_1'
      traefik.port: '80'
      traefik.frontend.rule: 'HostRegexp:{subdomain:[a-z]+}.docker.localhost'
{% if varnish.enable %}

  varnish:
    image: 'wodby/drupal-varnish:$VARNISH_TAG'
    depends_on:
      - {{ webserver.type }}
    environment:
      VARNISH_SECRET: secret
      VARNISH_BACKEND_HOST: {{ webserver.type }}
      VARNISH_BACKEND_PORT: 80
    labels:
      traefik.backend: '{{ project_name }}_varnish_1'
      traefik.port: '6081'
      traefik.frontend.rule: 'Host:varnish.{{ project_name }}.docker.localhost'
{% endif %}
{% if redis.enable %}

  redis:
    image: 'wodby/redis:$REDIS_TAG'
{% endif %}

{% if dbbrowser.type == 'adminer' %}
  adminer:
    image: 'wodby/adminer:$ADMINER_TAG'
    environment:
      ADMINER_SALT: adminer-salt
    labels:
      traefik.backend: '{{ project_name }}_adminer_1'
      traefik.port: '9000'
      traefik.frontend.rule: 'Host:adminer.{{ project_name }}.docker.localhost'
{% elseif dbbrowser.type == 'pma' %}
  pma:
    image: 'phpmyadmin/phpmyadmin'
    environment:
      PMA_HOST: mariadb
      PMA_USER: drupal
      PMA_PASSWORD: drupal
      PHP_UPLOAD_MAX_FILESIZE: 1G
      PHP_MAX_INPUT_VARS: 1G
    labels:
      traefik.backend: '{{ project_name }}_pma_1'
      traefik.port: '80'
      traefik.frontend.rule: 'Host:pma.{{ project_name }}.docker.localhost'
{% endif %}
{% if solr.enable %}

  solr:
    image: 'wodby/drupal-solr:$SOLR_TAG'
    environment:
      SOLR_HEAP: 1024m
    labels:
      traefik.backend: '{{ project_name }}_solr_1'
      traefik.port: '8983'
      traefik.frontend.rule: 'Host:solr.{{ project_name }}.docker.localhost'
{% endif %}

  mailhog:
    image: 'mailhog/mailhog'
    labels:
      traefik.backend: '{{ project_name }}_mailhog_1'
      traefik.port: '8025'
      traefik.frontend.rule: 'Host:mailhog.{{ project_name }}.docker.localhost'
{% if node.enable %}

  nodejs:
    image: 'wodby/drupal-node:$DRUPAL_NODE_TAG'
    environment:
       NODE_SERVICE_KEY: '{{ node.key }}'
    labels:
      traefik.backend: 'nodejs'
      traefik.port: '8080'
      traefik.frontend.rule: 'Host:nodejs.{{ project_name }}.docker.localhost'
    volumes:
      - ./{{ node.path }}:/app
    command: sh -c 'npm install && npm run start'

  node:
    image: 'node:alpine'
    working_dir: /app
    labels:
      traefik.backend: '{{ project_name }}_node_1'
      traefik.port: '3000'
      traefik.frontend.rule: 'Host:front.{{ project_name }}.docker.localhost'
    expose:
      - '3000'
    volumes:
      - ./{{ node.path }}:/app
    command: sh -c 'npm install && npm run start'
{% endif %}
{% if memcached.enable %}

  memcached:
    image: 'wodby/memcached:$MEMCACHED_TAG'
{% endif %}
{% if rsyslog.enable %}

  rsyslog:
    image: 'wodby/rsyslog:$RSYSLOG_TAG'
{% endif %}
{% if athenapdf.enable %}

  athenapdf:
    image: 'arachnysdocker/athenapdf-service'
    environment:
      WEAVER_AUTH_KEY: '{{ athenapdf.key }}'
      WEAVER_ATHENA_CMD: 'athenapdf -S'
      WEAVER_MAX_WORKERS: 10
      WEAVER_MAX_CONVERSION_QUEUE: 50
      WEAVER_WORKER_TIMEOUT: 90
      WEAVER_CONVERSION_FALLBACK: false
{% endif %}
{% if blackfire.enable %}

  blackfire:
    image: 'blackfire/blackfire'
    environment:
      BLACKFIRE_SERVER_ID: '{{ blackfire.id }}'
      BLACKFIRE_SERVER_TOKEN: '{{ blackfire.token }}'
{% endif %}
{% if webgrind.enable %}

  webgrind:
    # add XDEBUG_PROFILE=1 to your request to profile that
    image: 'wodby/webgrind:$WEBGRIND_TAG'
    environment:
      WEBGRIND_PROFILER_DIR: '/mnt/files/xdebug/profiler'
    labels:
      traefik.backend: '{{ project_name }}_webgrind_1'
      traefik.port: '8080'
      traefik.frontend.rule: 'Host:webgrind.{{ project_name }}.docker.localhost'
    volumes:
      - files:/mnt/files
{% endif %}

  portainer:
    image: portainer/portainer
    container_name: "{{ project_name }}_portainer"
    command: --no-auth -H unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - 'traefik.backend=portainer'
      - 'traefik.port=9000'
      - 'traefik.frontend.rule=Host:portainer.{{ project_name }}.docker.localhost'

  traefik:
    image: traefik
    container_name: "{{ project_name }}_traefik"
    command: -c /dev/null --web --docker --logLevel=INFO
    ports:
      - '8000:80'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
{#networks:#}
  {#default:#}
    {#external:#}
      {#name: traefik_{{ project_name }}#}