#!/bin/bash
#
# Deploy artifacts.
#

# Generate variables depending on the current CI job variables.
eval PROJECT_PATH=\$${SERVER}"_SERVER_DIR"
eval HOST=\$${SERVER}"_SERVER_HOST"
eval USER=\$${SERVER}"_SERVER_USER"
eval PRIVATE_KEY=\$${SERVER}"_SERVER_PRIVATE_KEY"

# Set variables.
DIR=$(basename "${PROJECT_PATH}")
SSH_AUTH="$USER@$HOST"

# Create file with privet ssh key from staging server.
cat >> ~/.ssh/stage_private_key <<EOF
$PRIVATE_KEY
EOF
chmod 600 ~/.ssh/stage_private_key

# Upload the archive with artifact to the server.
echo scp -i ~/.ssh/stage_private_key $ARTIFACT_DIR/$BRANCH.tgz $SSH_AUTH:$PROJECT_PATH/$BRANCH.tgz
scp -i ~/.ssh/stage_private_key $ARTIFACT_DIR/$BRANCH.tgz $SSH_AUTH:$PROJECT_PATH/$BRANCH.tgz

# SSH to the server, unzip archive, rsync and deploy.
DEPLOY="cd $PROJECT_PATH &&
       mkdir tmp-$BRANCH
       tar -zxf $BRANCH.tgz -C tmp-$BRANCH &&
       rsync -a --del --exclude-from 'tmp-$BRANCH/deploy/.rsync-deploy-exclude' tmp-$BRANCH/ $DIR-$BRANCH/ &&
       rm $BRANCH.tgz &&
       rm -rf tmp-$BRANCH &&
       cd $DIR-$BRANCH &&
       make "$COMMAND

echo ssh -ttq -i ~/.ssh/stage_private_key $SSH_AUTH "export TERM='xterm' && $DEPLOY"
ssh -ttq -i ~/.ssh/stage_private_key $SSH_AUTH "export TERM='xterm' && $DEPLOY"

# Remove private key.
rm ~/.ssh/stage_private_key