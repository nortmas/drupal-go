variables:
  ARTIFACT_DIR: {{ deploy.runner_artifact_dir }}
  DEV_SERVER_DIR: {{ dev_server.project_dir }}
  DEV_SERVER_HOST: {{ dev_server.host }}
  DEV_SERVER_USER: {{ dev_server.user }}
  PROD_SERVER_DIR: {{ prod_server.project_dir }}
  PROD_SERVER_HOST: {{ prod_server.host }}
  PROD_SERVER_USER: {{ prod_server.user }}

stages:
  - deploy
  - test

deploy_dev:
  stage: deploy
  only:
    - dev
  variables:
   BRANCH: dev
   SERVER: DEV
  before_script:
    - chmod -R 764 ./deploy/scripts/*
    - ./deploy/scripts/artifact.sh
  script:
    - ./deploy/scripts/deploy.sh
  after_script:
    - ./deploy/scripts/finalize.sh

deploy_stage:
  stage: deploy
  only:
    - stage
  variables:
   BRANCH: stage
   SERVER: PROD
  before_script:
    - chmod -R 764 ./deploy/scripts/*
    - ./deploy/scripts/artifact.sh
  script:
    - ./deploy/scripts/deploy.sh
  after_script:
    - ./deploy/scripts/finalize.sh

deploy_master:
  stage: deploy
  only:
    - master
  variables:
   BRANCH: master
   SERVER: PROD
  before_script:
    - chmod -R 764 ./deploy/scripts/*
    - ./deploy/scripts/artifact.sh
  script:
    - ./deploy/scripts/deploy.sh
  after_script:
    - ./deploy/scripts/finalize.sh
{% if behat.enable %}

behat_build:
  stage: test
  only:
    - dev
  variables:
   BRANCH: dev
  before_script:
    - chmod -R 764 ./go/build-scripts/*
  script:
    - ./go/build-scripts/behat.sh
  after_script:
    - ./go/build-scripts/finalize.sh
  artifacts:
    when: always
    paths:
      - tests/behat/_output
  allow_failure: true
  when: on_success
{% endif %}