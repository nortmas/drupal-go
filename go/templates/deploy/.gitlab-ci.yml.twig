variables:
  ARTIFACT_DIR: {{ deploy.runner_artifact_dir }}

stages:
  - deploy
  - test

{% for key, server in servers %}
deploy_{{key}}:
  stage: deploy
  image: nortmas/drupal-go-runner
  tags:
    - docker
  only:
    - {{server.branch}}
  variables:
   BRANCH: {{server.branch}}
   SERVER_DIR: {{ server.project_dir }}
   SERVER_HOST: {{ server.host }}
   SERVER_USER: {{ server.user }}
   COMMAND: go_{{key}}_deploy
  before_script:
    - chmod -R 764 ./deploy/scripts/*
    - ./deploy/scripts/artifact.sh
  script:
    - ./deploy/scripts/deploy.sh
  after_script:
    - ./deploy/scripts/finalize.sh

{% endfor %}
{% if behat.enable %}
behat_build:
  stage: test
  image: nortmas/drupal-go-runner
  tags:
    - docker
  only:
    - dev
  variables:
   BRANCH: dev
  before_script:
    - chmod -R 764 ./go/build-scripts/*
  script:
    - ./go/build-scripts/behat.sh
  after_script:
    - ./go/build-scripts/finalize.sh
  artifacts:
    when: always
    paths:
      - tests/behat/_output
  allow_failure: true
  when: on_success
{% endif %}